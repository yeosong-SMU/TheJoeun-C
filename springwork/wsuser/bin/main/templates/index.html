<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>실시간 접속자</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<h1>실시간 접속자</h1>

<div id="notices" aria-live="polite"></div>

<div>
	<div>
		<input id="nickname" type="text" placeholder="닉네임을 입력하세요" />
		<button id="btnJoin">입장</button>
		<button id="btnLeave" disabled>퇴장</button>
	</div>
	<p>현재 접속자 수: <span id="count">0</span></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
let stompClient = null;
let connected = false;

const $nick = document.getElementById('nickname');
const $join = document.getElementById('btnJoin');
const $leave = document.getElementById('btnLeave');
const $count = document.getElementById('count');
const $notices= document.getElementById('notices');

function setButtons(state) {
	connected = state;
	$join.disabled = state;
	$leave.disabled = !state;
	$nick.disabled = state;
}

function appendNoticeLine(at, nickname, type) {
	const div = document.createElement('div');
	div.textContent = `${at} - ${nickname}님이 ${type === 'JOIN' ? '입장하셨습니다' : '퇴장하셨습니다'}.`;
	$notices.prepend(div);
	
	while ($notices.children.length > 10) {
		$notices.removeChild($notices.lastChild);
	}
}

async function loadSnapshot() {
	const res = await fetch('/api/presence/snapshot?limit=10');
	const data = await res.json();
	
	$count.textContent = data.status.count;
	
	$notices.innerHTML = '';
	data.logs.slice().reverse().forEach(l => {
		appendNoticeLine(l.at, l.nickname, l.type);
	});
}

function connectStomp() {
	const sock = new SockJS('/ws');
	stompClient = Stomp.over(sock);
	
	stompClient.connect({}, () => {
		setButtons(true);
		stompclient.subscribe('/topic/online', (msg) => {
			const payload = JSON.parse(msg.body);
			
			if (typeof payload.count === 'number') {
				$count.textContent = payload.count;
			}
			
			if (payload.event) {
				const {type, nickname, at} = payload.event;
				appendNoticeLine(at, nickname, type);
			}
		});
	});
}

function connectAndJoin(nickname) {
	if (!stompClient || !connected) {
		const sock = new SockJS('/ws');
		stompClient = Stomp.over(sock);
		stompClient.connect({}, () => {
			setButtons(true);
			stompClient.send('/app/join', {}, nickname || '손님');
			stompClient.subscribe('/topic/online', (msg) => {
				const payload = JSON.parse(msg.body);
				if(typeof payload.count === 'number') {
					$count.textContent = payload.count;
				}
				if(payload.event) {
					const { type, nickname, at } = payload.event;
					appendNoticeLine(at, nickname, type);
				}
			});
		});
	} else {
		stompClient.send('/app/join', {}, nickname || '손님');
	}
}

function disconnect() {
	if(stompClient) {
		stompClient.disconnect(() => setButtons(false));
		stompClient = null;
	}
}

$join.addEventListener('click', () => {
	const nickname = ($nick.value || '').trim() || '손님';
	connectAndJoin(nickname);
});

$leave.addEventListener('click', () => {
	disconnect();
});

window.addEventListener('load', async () => {
	await loadSnapshot();
	connectStomp();
});

window.addEventListener('beforeunload', () => {
	if(connected) {
		try { stompClient.disconnect(); } catch (e) {}
	}
});
</script>
</body>
</html>