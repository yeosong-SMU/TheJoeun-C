<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Calendar</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js'></script>
</head>
<body>
<div class="container p-4">
	<h1>일정 관리</h1>
	<div id='calendar'></div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">일정 상세</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="eventId">
				<div class="mb-3">
					<label for="eventTitle" class="form-label">제목</label>
					<input type="text" class="form-control" id="eventTitle">
				</div>
				<div class="mb-3">
					<label for="eventStart" class="form-label">시작일</label>
					<input type="date" class="form-control" id="eventStart">
				</div>
				<div class="mb-3">
					<label for="eventEnd" class="form-label">종료일</label>
					<input type="date" class="form-control" id="eventEnd">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" id="deleteBtn">삭제</button>
				<button type="button" class="btn btn-primary" id="updateBtn">수정</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function(){
	const calendarEl = document.getElementById('calendar');
	
	axios.get('/events').then(response => {
		const events = response.data;
		
		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'dayGridMonth',
			headerToolbar: {
				left: 'prev,next today',
				center: 'title',
				right: 'dayGridMonth,timeGridWeek,timeGridDay'
			},
			editable: true,
			eventResizableFromStart: true,
			events: events.map(e => ({
				id: e.id,
				title: e.title,
				start: e.startDate,
				end: e.endDate
			})),
			dateClick: function(info) {
				const title = prompt('일정 제목을 입력하세요: ');
				if(title) {
					axios.post('/events', {
						title: title,
						startDate: info.dateStr,
						endDate: info.dateStr
					}).then(res => {
						calendar.addEvent({
							id: res.data.id,
							title: res.data.title,
							start: res.data.startDate,
							end: res.data.endDate
						});
					});
				}
			},
			eventClick: function(info) {
				const modal = new bootstrap.Modal(document.getElementById('eventModal'));
				modal.show();
				
				document.getElementById('eventId').value = info.event.id;
				document.getElementById('eventTitle').value = info.event.title;
				document.getElementById('eventStart').value = info.event.startStr;
				document.getElementById('eventEnd').value = info.event.endStr;
			}
		});
		
		calendar.render();
		
		document.getElementById('updateBtn').addEventListener('click', function() {
			const id = document.getElementById('eventId').value;
			const title = document.getElementById('eventTitle').value;
			const start = document.getElementById('eventStart').value;
			const end = document.getElementById('eventEnd').value;
			
			axios.put('/events/' + id, {
				title: title,
				startDate: start,
				endDate: end
			}).then(() => {
				const event = calendar.getEventById(id);
				event.setProp('title', title);
				event.setStart(start);
				event.setEnd(end);
				bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
			});
		});
		
		document.getElementById('deleteBtn').addEventListener('click', function() {
			if(confirm("삭제하시겠습니까?")){
				const id = document.getElementById('eventId').value;
				axios.delete('/events/' + id).then(() => {
					const event = calendar.getEventById(id);
					event.remove();
					bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
				});
			}
		});
	});
});
</script>
</body>
</html>