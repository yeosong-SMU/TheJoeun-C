<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Churn 수정</title>
<script>
const API_BASE = 'http://localhost:5000';

function debounce(fn, delay = 250) {
	let t;
	return (...args) => {
		clearTimeout(t);
		t = setTimeout(() => fn(...args), delay);
	};
}

function buildPayload() {
	const age = document.getElementById('age').value;
	const tenureMonths = document.getElementById('tenureMonths').value;
	const monthlyCharges = document.getElementById('monthlyCharges').value;
	const gender = document.getElementById('gender').value;
	const contractType = document.getElementById('contractType').value;
	const paymentMethod = document.getElementById('paymentMethod').value;
	const internetService = document.getElementById('internetService').value;
	
	if(!age || !tenureMonths || !monthlyCharges || !gender
			|| !contractType || !paymentMethod || !internetService) {
		return null;
	}
	
	return {
		age: Number(age),
		tenure_months: Number(tenureMonths),
		monthly_charges: Number(monthlyCharges),
		gender: gender, 
		contract_type: contractType,
		payment_method: paymentMethod,
		internet_service: internetService
	};
}
	
async function fetchPrediction() {
	const payload = buildPayload();
	if(!payload) return;
	
	try {
		const res = await fetch(`${API_BASE}/predict`, {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify(payload)
		});
		if(!res.ok) throw new Error(`HTTP ${res.status}`);
		const data = await res.json();
		
		const probPct = (data.churn_probability * 100).toFixed(1) + '%';
		document.getElementById('probText').textContent = probPct;
		
		const churnInput = document.getElementById('churn');
		if(churnInput) {
			churnInput.value = data.predicted_churn;
		}
	} catch(err) {
		console.error(err);
		document.getElementById('probText').textContent = '오류';
	}
}

const debouncedFetch = debounce(fetchPrediction, 300);

document.addEventListener('DOMContentLoaded', () => {
	const ids = [
		'age', 'gender', 'tenureMonths', 'monthlyCharges',
		'contractType', 'paymentMethod', 'internetService'
	];
	ids.forEach(id => {
		const el = document.getElementById(id);
		if(!el) return;
		el.addEventListener('change', debouncedFetch);
		el.addEventListener('input', debouncedFetch);
	});
	
	debouncedFetch();
});

function confirmDelete() {
	if(confirm('정말 삭제하시겠습니까?')) {
		document.form1.action = '/churn/delete?customerId=' + document.getElementById('customerId').value;
		document.form1.submit();
	}
}
</script>
</head>
<body>
<h1>Churn 수정</h1>
<form name="form1" action="/churn/edit" method="post" th:object="${churn}">
	<label for="customerId">고객 ID</label>
	<input type="text" id="customerId" name="customerId" th:field="*{customerId}" readonly><br><br>
	
	<label for="age">나이</label>
	<input type="number" id="age" name="age" th:field="*{age}" required><br><br>
	
	<label for="gender">성별</label>
	<select id="gender" name="gender" th:field="*{gender}" required>
		<option value="남성" th:selected="*{gender} == '남성'">남성</option>
		<option value="여성" th:selected="*{gender} == '여성'">여성</option>
	</select><br><br>
	
	<label for="tenureMonths">계약 기간 (개월)</label>
	<input type="number" id="tenureMonths" name="tenureMonths" th:field="*{tenureMonths}" required><br><br>
	
	<label for="monthlyCharges">월 요금</label>
	<input type="number" step="0.01" id="monthlyCharges" name="monthlyCharges" th:field="*{monthlyCharges}" required><br><br>
	
	<label for="contractType">계약 유형</label>
	<select id="contractType" name="contractType" th:field="*{contractType}" required>
		<option value="월별 계약" th:selected="*{contractType} == '월별 계약'">월별 계약</option>
		<option value="1년 계약" th:selected="*{contractType} == '1년 계약'">1년 계약</option>
		<option value="2년 계약" th:selected="*{contractType} == '2년 계약'">2년 계약</option>
	</select><br><br>
	
	<label for="paymentMethod">결제 방식</label>
	<select id="paymentMethod" name="paymentMethod" th:field="*{paymentMethod}" required>
		<option value="카드" th:selected="*{paymentMethod} == '카드'">카드</option>
		<option value="계좌 이체" th:selected="*{paymentMethod} == '계좌 이체'">계좌 이체</option>
	</select><br><br>
	
	<label for="internetService">인터넷 서비스</label>
	<select id="internetService" name="internetService" th:field="*{internetService}" required>
		<option value="100M" th:selected="*{internetService} == '100M'">100M</option>
		<option value="500M" th:selected="*{internetService} == '500M'">500M</option>
		<option value="1G" th:selected="*{internetService} == '1G'">1G</option>
		<option value="없음" th:selected="*{internetService} == '없음'">없음</option>
	</select><br><br>
	
	<label for="churn">이탈여부</label>
	<input type="text" id="churn" name="churn" th:field="*{churn}" required><br><br>
	
	<span>예측 이탈 확률: <strong id="probText">-</strong></span><br><br>
	
	<button type="submit">Churn 수정</button>
	<button type="button" onclick="confirmDelete()">삭제</button>
	<button type="button" onclick="location.href='/churn'">목록</button>
</form>
</body>
</html>