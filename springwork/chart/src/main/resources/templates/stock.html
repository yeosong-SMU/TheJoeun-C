<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>랜덤 주가 시뮬레이터</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>랜덤 주가 시뮬레이터</h2>

<form method="get" action="/stock">
	일수 <input type="number" name="days" min="10" max="1095" th:value="${params['days']}" />
	기대수익률 <input type="number" step= "0.01" name="mu" th:value="${params['mu']}" />
	변동성 <input type="number" step= "0.01" name="sigma" th:value="${params['sigma']}" />
	시작가격 <input type="number" step= "0.01" name="s0" th:value="${params['s0']}" />
	시드 <input type="number" name="seed" th:value="${params['seed']}" />
	<button type="submit">실행</button>
	<button type="button" onclick="location.href='/'">Home</button>
</form>

<canvas id="price" width="640" height="320"></canvas>
<canvas id="retHist" width="640" height="320"></canvas>

<script th:inline="javascript">
// 타임리프 데이터 치환, 데이터 없으면 빈 리스트
const rows = /*[[${data}]]*/ [];

const labels = rows.map(r => r.date);
const price = rows.map(r => r.price);
const rets = rows.map(r => r.ret);

if (!rows.length) {
	console.warn("데이터가 비어 있습니다. 컨트롤러에서 'data'를 넣어 주세요.");
}

new Chart(document.getElementById('price').getContext('2d'), {
	type: 'line',
	data: {
		labels,
		datasets: [{
			label: '가격',
			data: price,
			borderColor: 'rgb(54, 162, 235)',
			borderWidth: 2,
			pointRedius: 0,
			tension: 0.2,
			fill: false
		}]
	},
	options: {
		responsive: false,
		scales: { y: { beginAtZero: false } },
		plugins: { legend: {display: true } }
	}
});

function hist(arr, bins=20) {
	if (!arr.length) return {x:[], y:[]};
	const min = Math.min(...arr), max = Math.max(...arr);
	const step = (max - min) / (bins || 1) || 1;
	const edges = Array.from({length: bins}, (_, i) => min + i*step);
	const counts = Array(bins).fill(0);
	arr.forEach(v => {
		let k = Math.min(bins-1, Math.max(0, Math.floor((v - min) / step)));
		counts[k]++;
	});
	const centers = edges.map(e => e + step/2);
	return {x: centers, y: counts};
}

const H = hist(rets, 20);

new Chart(document.getElementById('retHist').getContext('2d'), {
	type: 'bar',
	data: {
		labels: H.x.map(x => x.toFixed(3)),
		datasets: [{
			label: '수익률 분포',
			data: H.y,
			backgroundColor: 'rgba(255, 99, 132, 0.5)',
			borderColor: 'rgb(255, 99, 132)',
			borderWidth: 1
		}]
	},
	options: {
		responsive: false,
		scales: { x: { ticks: { maxTicksLimit: 10 } } }
	}
});
</script>
</body>
</html>